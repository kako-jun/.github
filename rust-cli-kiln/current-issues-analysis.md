# Rust CLI Kiln - 現在の問題分析と緊急対応計画

**重要**: このドキュメントとプロジェクトに関するすべてのやりとりは日本語で行うこと。

## 緊急対応が必要な現状

**目標**: 今日中に3プロジェクト（diffai、diffx、lawkit）すべてを安定リリース

### 現在の各プロジェクト状況

#### 1. diffai
- **状態**: リリース済み（v0.3.15）だがnpmパブリッシュ後テストで問題
- **失敗テスト**: 5個
  - JSON出力形式の問題（無効なJSON）
  - YAML出力形式の問題
  - CLIバージョンコマンドの問題
  - CLIヘルプコマンドの問題
  - ファイル出力オプションの問題
- **影響度**: 中程度（リリース済みだが品質問題）

#### 2. diffx  
- **状態**: testsフォルダ整理後、テスト失敗
- **失敗テスト**: 1個
  - `basic_commands::test_help_command`が失敗
- **成功テスト**: 40個が正常
- **影響度**: 中程度（1つのテスト修正で解決可能）

#### 3. lawkit
- **状態**: testsフォルダ整理後、テスト失敗
- **失敗テスト**: 2個
  - `benford_calculations::benford_distribution_tests::test_chi_square_with_deviation`
  - `japanese_numerals::japanese_numeral_conversion_tests::test_mixed_japanese_and_context`
- **成功テスト**: 80個が正常
- **コンパイル警告**: 複数あるが動作には影響なし
- **影響度**: 中程度（2つのテスト修正で解決可能）

## 問題の根本原因分析

### 1. testsフォルダ整理による影響
diffxとlawkitで最近testsフォルダの整理を行った結果、テストが通らなくなっている。
考えられる原因：
- テストファイルのパス変更によるimport/useの問題
- テストモジュール構造の変更による参照エラー
- フィクスチャファイルの参照パスの問題

### 2. CLIオプション名の不整合
diffaiのnpmテストで`--output-format`オプションが`--output`オプションと混同されている。
これは以下の問題を示唆：
- テストコードとCLI実装の不整合
- 3プロジェクト間でのオプション名統一不足
- ドキュメントとの齟齬

## 緊急対応戦略（修正版）

**朗報**: 状況は想定より良好。合計8個の失敗のみで、大部分のテストは正常動作。

### 段階1: 問題の詳細把握 ✅ 完了
- diffai: 5個のnpmテスト失敗（オプション名の問題が主因）
- diffx: 1個のcargoテスト失敗（help_command）
- lawkit: 2個のcargoテスト失敗（統計計算とテキスト処理）

### 段階2: 修正優先順位決定（現在進行中）
**高優先度（リリースブロッカー）**:
1. diffx: help_commandテストの修正
2. lawkit: 2つの失敗テストの修正

**中優先度（品質向上）**:
3. diffai: npmテストの修正（主にオプション名統一）

### 段階3: 集中修正実施（45分目標）
1. **diffx修正** (10分): CLIヘルプ出力の期待値修正
2. **lawkit修正** (15分): 統計テストと日本語処理テストの修正
3. **diffai修正** (20分): npmテストのオプション名修正

### 段階4: リリース検証（30分目標）
1. 3プロジェクトのテスト全通確認
2. ローカルでの04,05,08番スクリプト実行
3. 3プロジェクト同時リリース

## 想定される修正項目

### A. 高優先度（リリースブロッカー）
- [ ] テストモジュールの参照修正
- [ ] CLIオプション名の統一
- [ ] 重要な機能テストの修正

### B. 中優先度（品質改善）
- [ ] 出力形式の問題修正
- [ ] エラーハンドリングの改善
- [ ] コンパイル警告の解消

### C. 低優先度（後回し可能）
- [ ] テストカバレッジの向上
- [ ] パフォーマンステストの追加
- [ ] ドキュメントの更新

## リスク評価

### 高リスク
- testsフォルダ整理による予期せぬ破綻が他にもある可能性
- 修正作業中に新たな問題が発覚する可能性
- 3プロジェクト同時修正による相互影響

### 中リスク  
- GitHub Actionsでの環境差異による失敗
- プラットフォーム固有の問題（macOS sedコマンド等）

### 低リスク
- ドキュメントの不整合
- 軽微な機能の問題

## 成功基準

### 最小限成功
- 3プロジェクトすべてでcargo testが通る
- 基本的なCLI機能が動作する
- ローカルでのリリーステストが通る

### 理想的成功  
- 上記に加えて、npmテストも全て通る
- GitHub Actionsでのリリースも成功
- 公開後のポストリリーステストも通る

## 次のアクション

1. **即座に**: 3プロジェクトの詳細なテスト結果を取得
2. **15分以内**: 問題の共通パターンを特定し修正計画を確定
3. **75分以内**: 修正実施とローカル検証完了
4. **120分以内**: 3プロジェクト同時リリース完了

---
*最終更新: 緊急対応開始時*